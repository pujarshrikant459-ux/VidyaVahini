
/**
 * @file Firebase Security Rules for a School Management Portal.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for parent data,
 * and school-based access control for school-related data.
 *
 * Data Structure:
 * - /schools/{schoolId}: Stores school information.
 * - /schools/{schoolId}/headmasters/{headmasterId}: Stores headmaster details for a school.
 * - /schools/{schoolId}/staff/{staffId}: Stores staff details for a school.
 * - /schools/{schoolId}/students/{studentId}: Stores student details for a school, including a parentId field.
 * - /schools/{schoolId}/students/{studentId}/attendance/{attendanceId}: Stores attendance records for a student.
 * - /schools/{schoolId}/homework/{homeworkId}: Stores homework assignments for a school.
 * - /schools/{schoolId}/timetables/{timetableId}: Stores timetables for a school.
 * - /schools/{schoolId}/transport/{transportId}: Stores transport details for a school.
 * - /schools/{schoolId}/fees/{feeId}: Stores fee records for a school.
 * - /parents/{parentId}: Stores parent information, including a denormalized studentIds array.
 *
 * Key Security Decisions:
 * - Parents can only read and write their own data.
 * - Parents can read data of the students linked in their `studentIds` array.
 * - School-related data is not directly secured in this prototype.
 * - Data validation is minimal in this prototype to allow for rapid iteration.
 * - Listing of parent documents is disallowed.
 *
 * Denormalization for Authorization:
 * The `Parent` document includes a `studentIds` array, denormalized from the `Student` documents,
 * to enable authorization rules that do not require reading `Student` documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows access to school documents. Authenticated users can create a school.
     * In a production environment, writes should be more restricted.
     * @path /schools/{schoolId}
     * @allow (get, list): Any user can read school information.
     * @allow (create): Any authenticated user can create a school.
     * @allow (update, delete): No one can modify school information.
     * @principle Open read access for school information; create is allowed for registration.
     */
    match /schools/{schoolId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Allows access to headmaster documents.  For now, all access is open.  In a
     * production environment, access should be restricted to authenticated users with specific
     * roles (e.g., school admins).
     * @path /schools/{schoolId}/headmasters/{headmasterId}
     * @allow (get, list): Any user can read headmaster information.
     * @allow (create, update, delete): No one can modify headmaster information.
     * @principle Open read access for headmaster information; writes are disallowed for now.
     */
    match /schools/{schoolId}/headmasters/{headmasterId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows access to staff documents. Admins can create staff.
     * @path /schools/{schoolId}/staff/{staffId}
     * @allow (get, list): Any user can read staff information.
     * @allow (create): Authenticated users (admins) can create staff.
     * @allow (update, delete): No one can modify staff information for now.
     * @principle Open read access for staff information; writes are restricted.
     */
    match /schools/{schoolId}/staff/{staffId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // Simplified for now. Should be admin-only.
      allow update, delete: if false;
    }

    /**
     * @description Allows access to student documents. Parents can read the documents of their
     * children. In a production environment, access should be restricted to authenticated users
     * with specific roles (e.g., school admins, teachers, or the student's parent).
     * @path /schools/{schoolId}/students/{studentId}
     * @allow (get, list): Any user can read student information for now. A parent can read their own child's info.
     * @allow (create, update, delete): No one can modify student information.
     * @principle Open read access for student information; writes are disallowed for now.
     */
    match /schools/{schoolId}/students/{studentId} {
      allow get, list: if true; // For admin/public access.
      allow get: if isSignedIn() && isParentOf(studentId);
      allow create, update, delete: if false;
    }

    /**
     * @description Allows access to attendance documents. For now, all access is open. In a
     * production environment, access should be restricted to authenticated users with specific
     * roles (e.g., school admins, teachers, or the student's parent).
     * @path /schools/{schoolId}/students/{studentId}/attendance/{attendanceId}
     * @allow (get, list): Any user can read attendance information.
     * @allow (create, update, delete): No one can modify attendance information.
     * @principle Open read access for attendance information; writes are disallowed for now.
     */
    match /schools/{schoolId}/students/{studentId}/attendance/{attendanceId} {
      allow get, list: if true; // Public access for now
      allow get, list: if isSignedIn() && isParentOf(studentId);
      allow create, update, delete: if false;
    }

    /**
     * @description Allows access to homework documents. For now, all access is open. In a
     * production environment, access should be restricted to authenticated users with specific
     * roles (e.g., teachers or students).
     * @path /schools/{schoolId}/homework/{homeworkId}
     * @allow (get, list): Any user can read homework information.
     * @allow (create, update, delete): No one can modify homework information.
     * @principle Open read access for homework information; writes are disallowed for now.
     */
    match /schools/{schoolId}/homework/{homeworkId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows access to timetable documents. For now, all access is open. In a
     * production environment, access should be restricted to authenticated users with specific
     * roles (e.g., school admins, teachers, or students).
     * @path /schools/{schoolId}/timetables/{timetableId}
     * @allow (get, list): Any user can read timetable information.
     * @allow (create, update, delete): No one can modify timetable information.
     * @principle Open read access for timetable information; writes are disallowed for now.
     */
    match /schools/{schoolId}/timetables/{timetableId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows access to transport documents. For now, all access is open. In a
     * production environment, access should be restricted to authenticated users with specific
     * roles (e.g., school admins).
     * @path /schools/{schoolId}/transport/{transportId}
     * @allow (get, list): Any user can read transport information.
     * @allow (create, update, delete): No one can modify transport information.
     * @principle Open read access for transport information; writes are disallowed for now.
     */
    match /schools/{schoolId}/transport/{transportId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows access to fee documents. For now, all access is open. In a
     * production environment, access should be restricted to authenticated users with specific
     * roles (e.g., school admins or the student's parent).
     * @path /schools/{schoolId}/fees/{feeId}
     * @allow (get, list): Any user can read fee information.
     * @allow (create, update, delete): No one can modify fee information.
     * @principle Open read access for fee information; writes are disallowed for now.
     */
    match /schools/{schoolId}/fees/{feeId} {
      allow get, list: if true; // Public access for now
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to parent documents, enforcing owner-only access.
     * @path /parents/{parentId}
     * @allow (get): A parent can read their own document.
     * @allow (create): A parent can create their own document, if the document ID matches their auth UID.
     * @allow (update): A parent can update their own document, if the document exists and they own it.
     * @allow (delete): A parent can delete their own document, if the document exists and they own it.
     * @deny (list): Listing parent documents is not allowed.
     * @principle Enforces document ownership for writes; restricts listing to prevent data exposure.
     */
    match /parents/{parentId} {
      allow get: if isSignedIn() && isOwner(parentId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(parentId);
      allow update: if isSignedIn() && isExistingOwner(parentId);
      allow delete: if isSignedIn() && isExistingOwner(parentId);
    }

    // --- Helper Functions ---

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document.
     * @param {string} userId The user ID to check against the request's auth UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    /**
     * @description Checks if the signed-in user is the parent of the student.
     * It relies on the denormalized `studentIds` array in the parent's document.
     * @param {string} studentId The ID of the student document.
     * @return {boolean} True if the user is the parent, false otherwise.
     */
    function isParentOf(studentId) {
      return isSignedIn() && studentId in get(/databases/$(database)/documents/parents/$(request.auth.uid)).data.studentIds;
    }

    /**
     * @description Checks if the user is the owner of the document and the document exists.
     * @param {string} userId The user ID to check against the request's auth UID.
     * @return {boolean} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && exists(/databases/$(database)/documents/parents/$(userId));
    }
  }
}

    